- name: Duelist deployment
  hosts: machines
  tasks:
    - name: Install certbot
      become: yes
      ansible.builtin.apt:
        pkg:
          - nginx
          - certbot
          - python3-certbot-nginx
#
    - name: Extract the front-end
      become: yes
      ansible.builtin.unarchive:
        src: ../dist/ui.tar.xz
        dest: /var/www/html

    - name: Create network
      community.docker.docker_network:
        name: duels_net

    - name: Pull MongoDB
      community.docker.docker_image:
        name: mongo
        tag: latest
        source: pull
        force_source: true

    - name: Run MongoDB
      community.docker.docker_container:
        image: mongo
        name: mongo
        published_ports: 27017:27017
        restart: true
        restart_policy: unless-stopped
        networks:
          - name: duels_net

    - name: Pull the backend
      community.docker.docker_image:
        name: europe-central2-docker.pkg.dev/duelscalculator/duels-all/backend
        tag: latest
        source: pull
        force_source: true

    - name: Ensure gcloud credentials dir exists
      ansible.builtin.file:
        path: /usr/local/etc/duels-calculator
        state: directory
        recurse: yes
      become: true

    - name: Copy the gcloud credentials
      ansible.builtin.copy:
        src: ./values/gcloud_credentials.json
        dest: /usr/local/etc/duels-calculator/gcloud_credentials.json
      become: true

    - name: Run the backend
      community.docker.docker_container:
        image: europe-central2-docker.pkg.dev/duelscalculator/duels-all/backend:latest
        name: duels_backend
        published_ports: 8080:80
        restart: true
        restart_policy: "unless-stopped"
        networks:
          - name: duels_net
        volumes:
          - /usr/local/etc/duels-calculator:/usr/local/etc/duels-calculator
        env:
          MONGO_URL: mongodb://mongo:27017
          GOOGLE_APPLICATION_CREDENTIALS: /usr/local/etc/duels-calculator/gcloud_credentials.json
          GCLOUD_BUCKET_NAME: duels-results
